{% extends "base/main.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4">

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
        <h1 class="text-3xl font-bold text-gray-800">Student Academic Results</h1>
        <a href="{% url 'accounts:student_add_result' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Add Result
        </a>
    </div>

    <!-- Filter Section -->
    <div class="bg-white p-4 rounded-lg shadow mb-8">
        <form method="get" class="flex flex-col sm:flex-row gap-4 sm:items-end">

            <!-- Search Input -->
            <div class="flex-1">
                <label class="block text-gray-700 text-sm mb-1" for="search">Search</label>
                <input type="text" id="search" name="search" value="{{ request.GET.search }}" placeholder="Name, email, roll..." 
                    class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>

            <!-- Year Filter -->
            <div>
                <label class="block text-gray-700 text-sm mb-1" for="year">Year</label>
                <select name="year" id="year" onchange="this.form.submit()"
                    class="border rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Years</option>
                    {% for y in years %}
                        <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Semester Filter -->
            <div>
                <label class="block text-gray-700 text-sm mb-1" for="semester">Semester</label>
                <select name="semester" id="semester" onchange="this.form.submit()"
                    class="border rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Semesters</option>
                    {% for s in semesters %}
                        <option value="{{ s }}" {% if selected_semester == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Class Filter -->
            <div>
                <label class="block text-gray-700 text-sm mb-1" for="class">Class</label>
                <select name="class" id="class" onchange="this.form.submit()"
                    class="border rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Classes</option>
                    {% for c in classes %}
                        <option value="{{ c }}" {% if selected_class == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Submit Button for Search -->
            <div class="sm:self-end">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    Apply
                </button>
            </div>

        </form>
    </div>

    {% if grouped_results %}

        {% for year, semesters in grouped_results.items %}
            <div class="mb-10">

                <!-- Year Header -->
                <h2 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2">Academic Year {{ year }}</h2>

                {% for semester, results in semesters.items %}
                    <div class="mb-8 bg-white rounded-xl shadow border overflow-x-auto">

                        <!-- Semester Header -->
                        <div class="bg-gray-100 px-6 py-4 border-b">
                            <h3 class="text-xl font-semibold text-gray-700">{{ semester }} Semester</h3>
                        </div>

                        <!-- Results Table -->
                        <table class="min-w-full border-collapse text-sm">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="p-3 border text-left">Student</th>
                                    <th class="p-3 border text-left">Class</th>
                                    <th class="p-3 border text-left">Roll</th>
                                    <th class="p-3 border text-left">Subject</th>
                                    <th class="p-3 border text-center">CGPA</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 border">
                                            {{ result.user.first_name }} {{ result.user.last_name }}
                                        </td>
                                        <td class="p-3 border">
                                            {{ result.user.studentprofile.class_list }}
                                        </td>
                                        <td class="p-3 border">
                                            {{ result.user.studentprofile.roll }}
                                        </td>
                                        <td class="p-3 border">
                                            {{ result.subject }}
                                        </td>
                                        <td class="p-3 border text-center font-semibold">
                                            {{ result.cgpa }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                    </div>
                {% endfor %}

            </div>
        {% endfor %}

    {% else %}
        <div class="text-center text-gray-500 text-lg py-10">
            No results found.
        </div>
    {% endif %}

</div>
{% endblock %}